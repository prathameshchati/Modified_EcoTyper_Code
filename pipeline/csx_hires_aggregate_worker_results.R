suppressPackageStartupMessages({
library(data.table)
})

args = c("discovery", "Lung", "TR12", "two_tiered")
args = commandArgs(T)
dataset_type = args[1]
dataset = args[2]
fractions = args[3]

input_dir = file.path("../CIBERSORTx/hires", dataset, fractions) 
output_dir = file.path("../CIBERSORTx/hires", dataset, fractions) 
dir.create(output_dir, recursive = T, showWarning = F)

cell_types = colnames(read.delim(file.path(output_dir, "classes.txt")))

for(cell_type in cell_types[1:length(cell_types)])
{
	print(paste("Preparing CIBERSORTxHiRes results for:", cell_type))
	folders = list.files(input_dir, pattern = paste0("worker_*"))
	all_input = NULL
	for(folder in folders)
	{
		#print(folder)
		files = list.files(file.path(input_dir, folder), pattern = paste0("CIBERSORTxHiRes_NA_", cell_type, "_Window*"))
		if(length(files) == 0)
		{
			stop(paste0("No CIBERSORTxHiRes results generated by ", folder, " for cell type ", cell_type, "!"))
		}
		raw_input = fread(file.path(input_dir, folder, files[1]), data.table = F)
		raw_input[is.na(raw_input)] <- 1
		raw_input = raw_input[apply(raw_input[,-1], 1, var) > 0,]
		
		all_input = rbind(all_input, raw_input)
		
	}
	raw_input = raw_input[order(raw_input[,1]),]
	write.table(all_input, file.path(output_dir, paste0(cell_type, ".txt")), sep = "\t", row.names = F)
	write.table(dim(all_input), file.path(output_dir, paste0(cell_type, ".dimensions.txt")), sep = "\t", row.names = F)
}

